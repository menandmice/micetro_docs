<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content="Disaster scenarios and recovery with PostgreSQL high availability in Micetro by Men&amp;Mice" name="description" />
<meta content="disaster recovery, PostgreSQL, high availability, Micetro" name="keywords" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Possible disaster scenarios &mdash; Micetro by Men&amp;Mice - 10.2  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Always On Availability Groups" href="mssql_ha.html" />
    <link rel="prev" title="PostgreSQL HA operations" href="psql_ha_maintenance.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Micetro by Men&Mice - 10.2
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Micetro by Men&amp;Mice</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security_announcements.html">Security announcements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../support.html">Contacting Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../opensource.html">Open-source licenses</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Micetro Install Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../implementation/implementation.html">Implementation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../implementation/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../implementation/advanced_config.html">Advanced configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../implementation/updates.html">Update Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Micetro User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/introduction.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/ui.html">Micetro user interface(s)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/folder_management.html">Folder management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/dns.html">DNS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/dhcp.html">DHCP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/ipam.html">IP address management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/devices.html">Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/active_directory.html">AD Sites and Subnets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual/automation.html">Automation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Micetro Admin Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/admin_system_settings.html">System Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/access_control.html">Access control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/admin_license.html">License Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/webapp_admin.html">Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/snmp_profiles.html">SNMP profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/admin_custom_properties.html">Custom Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/admin_schedule_scripts.html">Scheduled Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/admin_maintenance.html">Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/appliance_management.html">Appliance management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual/caching_appliance.html">Caching DNS Servers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="reference.html">Micetro reference articles</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="permissions.html">Permissions reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_convert.html">Converting existing access control configurations in Micetro 10.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="appliance_guide.html">Virtual Appliance Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="send_license_info.html">How to export and send license information</a></li>
<li class="toctree-l2"><a class="reference internal" href="health_bar_information.html">Health Bar information (Management Console)</a></li>
<li class="toctree-l2"><a class="reference internal" href="dynamic_zones.html">Dynamic Zones</a></li>
<li class="toctree-l2"><a class="reference internal" href="aws_route53.html">Configuring Amazon Route53</a></li>
<li class="toctree-l2"><a class="reference internal" href="powerdns.html">Configuring PowerDNS</a></li>
<li class="toctree-l2"><a class="reference internal" href="external_scripts.html">External scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="named-conf_location.html">named.conf validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="named-checkconf_timeout.html">Updating timeout value for named-checkconf</a></li>
<li class="toctree-l2"><a class="reference internal" href="change_updater_port.html">Changing the TCP port for the Men&amp;Mice Update Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="setup_msa.html">Setting up a Managed Service Account to run M&amp;M DNS/DHCP Server Controllers</a></li>
<li class="toctree-l2"><a class="reference internal" href="bind_file_structure.html">BIND DNS File Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="disable_auto_zone-transfer.html">Disable “Automatic adjustment of Zone Transfer”</a></li>
<li class="toctree-l2"><a class="reference internal" href="dns_controller_include.html">Men&amp;Mice DNS Server Controller and $INCLUDE Directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="dns_controller_generate.html">Expanding $GENERATE directives into records</a></li>
<li class="toctree-l2"><a class="reference internal" href="central_python_ldap.html">Installing Python for Men&amp;Mice Central on Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="snmp_oid.html">Which SNMP OIDs are used by Micetro in IP address and Subnet Discovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_console.html">Managing access control in the Management Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="access_control_example.html">Role-based access example</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_convert.html">Converting existing access control configurations in Micetro 10.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="ie_eol.html">Discontinuation of support for Internet Explorer</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="psql_ha.html">Setting up the PostgreSQL High Availability environment</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="psql_ha.html#install-pg-auto-failover">Install pg_auto-failover</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="psql_ha.html#install-requirements">Install requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="psql_ha.html#set-up-the-mmsuite-database-and-edit-config-files">Set up the mmsuite database and edit config files</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="psql_ha.html#further-information">Further information</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="mssql_ha.html">Always On Availability Groups</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Micetro by Men&Mice - 10.2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="reference.html">Micetro reference articles</a></li>
          <li class="breadcrumb-item"><a href="psql_ha.html">Setting up the PostgreSQL High Availability environment</a></li>
      <li class="breadcrumb-item active">Possible disaster scenarios</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/guides/reference/psql_disaster_recovery.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="possible-disaster-scenarios">
<span id="psql-disaster-recovery"></span><h1>Possible disaster scenarios<a class="headerlink" href="#possible-disaster-scenarios" title="Link to this heading"></a></h1>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Failure of:</p></th>
<th class="head"><p>Machine
affected</p></th>
<th class="head"><p>HA system response</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="3"><p>PSQL database service</p></td>
<td><p>Primary</p></td>
<td><p>Failover, automatic service reboot. Replication stops in the meantime.</p></td>
</tr>
<tr class="row-odd"><td><p>Secondary</p></td>
<td><p>Automatic service reboot. Replication stops in the meantime.</p></td>
</tr>
<tr class="row-even"><td><p>Monitor</p></td>
<td><p>Automatic service reboot. Replication continues but no failover possible in the meantime.</p></td>
</tr>
<tr class="row-odd"><td rowspan="4"><p>Server shutdown</p></td>
<td><p>Primary</p></td>
<td><p>Failover. Replication stops, waits for a signal from secondary.</p></td>
</tr>
<tr class="row-even"><td><p>Secondary</p></td>
<td><p>Replication on primary stops. Waits for a signal from secondary.</p></td>
</tr>
<tr class="row-odd"><td><p>Monitor</p></td>
<td><p>The primary database is still usable.
Primary and secondary nodes wait for a connection to monitor. Replication continues.</p></td>
</tr>
<tr class="row-even"><td><p>All</p></td>
<td><p>Database unavailable, no replication, no failover possible.</p></td>
</tr>
<tr class="row-odd"><td rowspan="4"><p>Server reboot</p></td>
<td><p>Primary</p></td>
<td><p>Failover, automatic service reboot on startup.</p></td>
</tr>
<tr class="row-even"><td><p>Secondary</p></td>
<td><p>Automatic service reboot. Replication stops in the meantime.</p></td>
</tr>
<tr class="row-odd"><td><p>Monitor</p></td>
<td><p>Automatic service reboot. Replication continues but no failover possible in the meantime.</p></td>
</tr>
<tr class="row-even"><td><p>All</p></td>
<td><p>Database unavailable, no replication, no failover possible.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">pg_autoctl</span></code>
corrupted and/or
deleted</p></td>
<td><p>All</p></td>
<td><p>Database unavailable, no replication, no failover possible.</p></td>
</tr>
</tbody>
</table>
<section id="controlled-switchover">
<h2>Controlled switchover<a class="headerlink" href="#controlled-switchover" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a controlled switchover situation it is possible to organize the sequence of events in a way to avoid data loss and lower downtime to a minimum. Because the HA cluster described here uses synchronous replication, triggering a manual failover doesn’t risk data loss risks. The monitor server keeps the current primary health at the time when the failover is triggered, and drives the failover accordingly.</p>
</div>
<p>Triggering a controlled switchover is the same as a manual failover described above.</p>
</section>
</section>
<section id="recovery">
<h1>Recovery<a class="headerlink" href="#recovery" title="Link to this heading"></a></h1>
<section id="database-service-failure">
<h2>Database service failure<a class="headerlink" href="#database-service-failure" title="Link to this heading"></a></h2>
<p>If the PostgreSQL database fails on one of the machines, the system will automatically reboot the affected service, but the replication process is unavailable for the duration.</p>
</section>
<section id="server-shutdown">
<h2>Server shutdown<a class="headerlink" href="#server-shutdown" title="Link to this heading"></a></h2>
<p>If either of the component machines is shut down, a manual restart is required. The failover processes will automatically start with the machine, and reinitialize the connections. If only the monitor server is affected, replication continues and failover is still possible.</p>
</section>
<section id="server-reboot">
<h2>Server reboot<a class="headerlink" href="#server-reboot" title="Link to this heading"></a></h2>
<p>The failover system is configured to automatically restart with the server, and no manual intervention is required. If only the monitor server is affected, replication continues but no failover can be triggered until it’s available.</p>
</section>
<section id="pg-autoctl-setup-failure">
<h2><code class="docutils literal notranslate"><span class="pre">pg_autoctl</span></code> setup failure<a class="headerlink" href="#pg-autoctl-setup-failure" title="Link to this heading"></a></h2>
<p>On the current primary database machine:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/usr/pgsql-12/bin/postgres<span class="w"> </span>-D<span class="w"> </span>/var/lib/pgsql/<span class="o">[</span>node-?<span class="o">]</span><span class="w"> </span>-p<span class="w"> </span><span class="o">[</span>port<span class="o">]</span>
</pre></div>
</div>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">preferences.cfg</span> <span class="pre">file</span></code> for Central, and change the following line, using the connection string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>postgres://[node-?]:[port]/mmsuite?target_session_attrs=read-write
</pre></div>
</div>
<p>Restart Central:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>restart<span class="w"> </span>mmcentral
</pre></div>
</div>
</section>
<section id="complete-shutdown">
<h2>Complete shutdown<a class="headerlink" href="#complete-shutdown" title="Link to this heading"></a></h2>
<p>If the startup scripts are correct in all of the machines a manual boot of the machines in the correct order (1. monitor; 2. primary; 3. secondary) will be enough to reinitialize the cluster.
On each machine, use the <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-ef</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">monitor</span></code> (or <code class="docutils literal notranslate"><span class="pre">primary</span></code>/<code class="docutils literal notranslate"><span class="pre">secondary</span></code>) command after boot to verify the <code class="docutils literal notranslate"><span class="pre">pg_autoctl</span></code> process is running.</p>
<p>If something’s not working, or you’d like to manually restart the services to recover, follow these steps.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can create bash scripts of each step to execute instead of manually running through them.</p>
</div>
<p>Start the monitor machine:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>su<span class="w"> </span>-<span class="w"> </span>postgres
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH</span><span class="s2">:/usr/pgsql-12/bin&quot;</span>
pg_autoctl<span class="w"> </span>run<span class="w"> </span>--pgdata<span class="w"> </span>./<span class="o">[</span>monitor<span class="o">]</span>/
</pre></div>
</div>
<p>Start the primary machine:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>su<span class="w"> </span>-<span class="w"> </span>postgres
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH</span><span class="s2">:/usr/pgsql-12/bin&quot;</span>
pg_autoctl<span class="w"> </span>run<span class="w"> </span>--pgdata<span class="w"> </span>./<span class="o">[</span>node-1<span class="o">]</span>/
</pre></div>
</div>
<p>If an error message states an instance is already running, remove the referenced file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rm<span class="w"> </span>/tmp/pg_autoctl/var/lib/pgsql/<span class="o">[</span>node-1<span class="o">]</span>/pg_autoctl.pid
</pre></div>
</div>
<p>And re-run the application:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pg_autoctl<span class="w"> </span>run<span class="w"> </span>--pgdata<span class="w"> </span>./<span class="o">[</span>node-1<span class="o">]</span>/
</pre></div>
</div>
<p>Start the secondary machine(s):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>su<span class="w"> </span>-<span class="w"> </span>postgres
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH</span><span class="s2">:/usr/pgsql-12/bin&quot;</span>
pg_autoctl<span class="w"> </span>run<span class="w"> </span>--pgdata<span class="w"> </span>./<span class="o">[</span>node-2<span class="o">]</span>/
</pre></div>
</div>
<p>If an error message states an instance is already running, remove the referenced file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rm<span class="w"> </span>/tmp/pg_autoctl/var/lib/pgsql/<span class="o">[</span>node-2<span class="o">]</span>/pg_autoctl.pid
</pre></div>
</div>
<p>And re-run the application:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pg_autoctl<span class="w"> </span>run<span class="w"> </span>--pgdata<span class="w"> </span>./<span class="o">[</span>node-2<span class="o">]</span>/
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="psql_ha_maintenance.html" class="btn btn-neutral float-left" title="PostgreSQL HA operations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mssql_ha.html" class="btn btn-neutral float-right" title="Always On Availability Groups" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Men&amp;Mice.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>